# syntax=docker/dockerfile:1

FROM node:20-alpine AS build
WORKDIR /app

# --- build-time metadata (для доказательства происхождения) ---
ARG GIT_SHA=unknown
ARG BUILD_TIME=unknown
ENV GIT_SHA=${GIT_SHA}
ENV BUILD_TIME=${BUILD_TIME}

# Dependences first (лучше кэш)
COPY package*.json ./
RUN npm ci

# Copy app sources
COPY . .

# ВАЖНО: форсируем sourcemap на уровне команды,
# даже если vite.config "почему-то" не подхватился
RUN npm run build -- --sourcemap

# Доп. артефакты для проверки происхождения
RUN printf "%s\n" "${GIT_SHA}" > /app/dist/build.txt \
 && printf '{"git_sha":"%s","build_time":"%s"}\n' "${GIT_SHA}" "${BUILD_TIME}" > /app/dist/build.json \
 && test -f /app/dist/index.html

# --- runtime image ---
FROM nginx:alpine

# OCI labels (видно в docker inspect)
ARG GIT_SHA=unknown
ARG BUILD_TIME=unknown
LABEL org.opencontainers.image.revision="${GIT_SHA}"
LABEL org.opencontainers.image.created="${BUILD_TIME}"

# nginx static
COPY --from=build /app/dist /usr/share/nginx/html

# sanity: гарантируем что .map реально попали (если vite их сделал)
# (не ломаем билд если maps отключены, но дадим сигнал в логах buildx)
RUN ls -la /usr/share/nginx/html/assets || true \
 && (ls -la /usr/share/nginx/html/assets/*.map >/dev/null 2>&1 && echo "✅ sourcemaps present" || echo "⚠️ sourcemaps NOT found")

EXPOSE 80
