name: Build & Deploy (GHCR)

on:
  push:
    branches: [ "main", "develop" ]

permissions:
  contents: read
  packages: write

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set vars
        id: vars
        run: |
          OWNER="${GITHUB_REPOSITORY_OWNER}"
          IMAGE="ghcr.io/${OWNER}/toptry-ai"
          SHORT_SHA="${GITHUB_SHA::7}"

          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            TAG="prod"
            CONTAINER="toptry-ai-prod"
            ENV_FILE="/opt/toptry-ai/.env"
            PORT_BIND="127.0.0.1:8080:8080"
            ALIAS="ai"
          else
            TAG="staging"
            CONTAINER="toptry-ai-staging"
            ENV_FILE="/opt/toptry-ai/.env.staging"
            PORT_BIND="127.0.0.1:8081:8080"
            ALIAS="ai-staging"
          fi

          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "sha_tag=sha-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "container=${CONTAINER}" >> $GITHUB_OUTPUT
          echo "env_file=${ENV_FILE}" >> $GITHUB_OUTPUT
          echo "port_bind=${PORT_BIND}" >> $GITHUB_OUTPUT
          echo "alias=${ALIAS}" >> $GITHUB_OUTPUT

      - name: Log in to GHCR (push)
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.vars.outputs.image }}:${{ steps.vars.outputs.tag }}
            ${{ steps.vars.outputs.image }}:${{ steps.vars.outputs.sha_tag }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy on server (pull + restart)
        run: |
          IMAGE="${{ steps.vars.outputs.image }}"
          TAG="${{ steps.vars.outputs.tag }}"
          CONTAINER="${{ steps.vars.outputs.container }}"
          ENV_FILE="${{ steps.vars.outputs.env_file }}"
          PORT_BIND="${{ steps.vars.outputs.port_bind }}"
          ALIAS="${{ steps.vars.outputs.alias }}"

          HOST="$(printf "%s" "${{ secrets.SSH_HOST }}" | tr -d '\r\n')"
          USER="$(printf "%s" "${{ secrets.SSH_USER }}" | tr -d '\r\n')"
          PORT="$(printf "%s" "${{ secrets.SSH_PORT }}" | tr -d '\r\n')"

          mkdir -p ~/.ssh
          printf "%s" "${{ secrets.SSH_KEY }}" > ~/.ssh/id_ed25519
          echo >> ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p "${PORT}" -H "${HOST}" >> ~/.ssh/known_hosts

          ssh -i ~/.ssh/id_ed25519 -p "${PORT}" "${USER}@${HOST}" bash -lc "set -e
            echo '${{ secrets.GHCR_TOKEN }}' | docker login ghcr.io -u '${{ secrets.GHCR_USER }}' --password-stdin
            docker pull ${IMAGE}:${TAG}
            docker rm -f ${CONTAINER} >/dev/null 2>&1 || true
            docker run -d \
              --name ${CONTAINER} \
              --restart unless-stopped \
              --network toptry-ai_default \
              --network-alias ${ALIAS} \
              --env-file ${ENV_FILE} \
              -p ${PORT_BIND} \
              ${IMAGE}:${TAG}
          "
